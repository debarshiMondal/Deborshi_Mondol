<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>{{PAGE_TITLE}}</title>
<style>
  :root{
    --blue:#1d4ed8; --blue-quiet:#eaf2ff; --blue-deep:#1e40af;
    --green:#16a34a; --green-quiet:#e8f7ee;
    --orange:#d97706; --orange-quiet:#fff4e5;
    --red:#dc2626;   --red-quiet:#fde8e8;
    --gray:#6b7280;  --ink:#0b0f19; --line:#e6e9ef; --bg:#f8fafc; --white:#fff;
    --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08),0 2px 6px rgba(0,0,0,.06);
  }
  *,*::before,*::after{box-sizing:border-box}

  /* Page structure: footer at end */
  html, body { height:100%; }
  html{ scroll-behavior:smooth; }
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    display:flex;flex-direction:column;min-height:100vh;
  }
  h1,h2{margin:0 0 12px 0;font-weight:900}
  h2{font-size:18px}
  p{margin:0}
  a{color:inherit}

  /* Header */
  header{
    background:linear-gradient(135deg,#0b0f19 0%,var(--blue-deep) 100%);
    color:#fff; box-shadow:var(--shadow);
  }
  .h-inner{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .h-title{display:flex;flex-direction:column;gap:6px}
  /* slightly reduced so long titles fit one line */
  .h-title h1{margin:0;font-size:clamp(16px,2vw,22px);font-weight:900;letter-spacing:.2px}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.28);
         color:#fff;padding:4px 10px;border-radius:999px;font-size:12px}
  .brand{display:flex;align-items:center;gap:8px}
  .brand img{height:32px;display:block;filter:drop-shadow(0 2px 2px rgba(0,0,0,.35))}
  .back{display:inline-flex;align-items:center;gap:6px;font-weight:700;font-size:12px;
        background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.35);
        border-radius:999px;padding:4px 8px;color:#fff;text-decoration:none}
  .back:hover{background:rgba(255,255,255,.18);text-decoration:none}

  main{max-width:1100px;margin:18px auto;padding:0 18px;flex:1 0 auto;}

  /* Cards & grid */
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .kv{display:grid;grid-template-columns:260px 1fr;gap:8px 14px}
  .kv .lbl{color:#111;font-weight:800}
  .kv .val{color:#111}

  /* Roles – sepia block INSIDE Summary */
  .roles-brief{
    background:#f5efe6;            /* sepia */
    border:1px solid #e7dbc8;
    border-radius:12px;
    padding:14px;
    box-shadow:0 4px 14px rgba(0,0,0,.05);
    margin-top:12px;
  }
  .roles-brief ul{margin:8px 0 0 0;padding-left:18px}
  .roles-brief li{margin:4px 0;color:#111}

  /* Inline anchor style used in summary/roles */
  .inline-link{color:var(--blue-deep);font-weight:800;text-decoration:none}
  .inline-link:hover{text-decoration:underline}

  /* Buttons */
  .btns{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .btn{
       display:flex;align-items:center;justify-content:space-between;gap:12px;
       padding:12px;border-radius:12px;border:1px solid var(--line);
       background:#fff;color:inherit;text-decoration:none;transition:.15s;
       font-weight:600;font-size:12.5px;
       box-shadow:0 1px 3px rgba(0,0,0,.05);
  }
  .btn:hover{ filter:brightness(1.06); box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .btn .left{display:flex;flex-direction:column}
  .btn .left strong{font-weight:800}
  .btn .count{min-width:auto;text-align:right;padding:0;border:none;background:transparent;font-weight:900;font-size:11.5px}

  .btn.green{background:var(--green-quiet)}
  .btn.orange{background:var(--orange-quiet)}
  .btn.red{background:var(--red-quiet)}
  .btn.blue{background:var(--blue-quiet)}

  .btn.green  .count{ color:var(--green);  }
  .btn.orange .count{ color:var(--orange); }
  .btn.red    .count{ color:var(--red);    }
  .btn.blue   .count{ display:none; }

  .btn-wrap{position:relative;display:flex;align-items:center;gap:8px}
  .card.action, .btns{overflow:visible;position:relative}
  .info-icon{
    font-size:12px;line-height:1;cursor:pointer;user-select:none;
    border:1px solid var(--line);border-radius:50%;width:18px;height:18px;
    display:flex;align-items:center;justify-content:center;background:var(--white);color:var(--gray);
  }
  .info-icon:hover{background:var(--blue-quiet);color:var(--blue);border-color:var(--blue)}

  .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
  .modal{background:#111;color:#fff;border-radius:12px;border:2px solid rgba(255,255,255,.9);max-width:640px;width:min(92vw,640px);padding:18px 20px;box-shadow:0 12px 28px rgba(0,0,0,.32)}
  .modal h3{margin:0 0 10px 0;font-size:16px}
  .modal p{font-size:16px;font-weight:800;line-height:1.4}
  .modal .actions{display:flex;justify-content:flex-end;margin-top:14px}
  .modal .btn-close{background:#fff;border:1px solid var(--line);color:#111;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}

  .grid .card.action{display:flex;flex-direction:column}
  .grid .card.action .btns{flex:1 1 auto;align-content:start}

  footer{background:#0b0f19;color:#fff;text-align:center;font-size:12px;padding:6px 10px;margin-top:24px}

  .btn{box-shadow: 0 2px 8px rgba(0,0,0,.10), 0 1px 3px rgba(0,0,0,.06);transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;}
  .btn:hover{transform: translateY(-2px);box-shadow: 0 8px 22px rgba(0,0,0,.18), 0 4px 10px rgba(0,0,0,.10);filter: brightness(1.09);}
  .btn:active{transform: translateY(-1px) scale(.995);box-shadow: 0 5px 14px rgba(0,0,0,.16), 0 3px 8px rgba(0,0,0,.10);filter: brightness(1.03);}
  .btn.green:hover, .btn.orange:hover, .btn.red:hover, .btn.blue:hover { filter: brightness(1.10); }

  /* 1-second flash highlight (subtle blue ring) */
  @keyframes flashRing {
    0%   { box-shadow: 0 0 0 0 rgba(29,78,216,.00), 0 1px 3px rgba(0,0,0,.05); }
    20%  { box-shadow: 0 0 0 4px rgba(29,78,216,.30), 0 8px 18px rgba(0,0,0,.10); }
    80%  { box-shadow: 0 0 0 4px rgba(29,78,216,.30), 0 8px 18px rgba(0,0,0,.10); }
    100% { box-shadow: 0 0 0 0 rgba(29,78,216,.00), 0 1px 3px rgba(0,0,0,.05); }
  }
  .btn.flash { animation: flashRing 1s ease; }
</style>
</head>
<body>
<header>
  <div class="h-inner">
    <div class="h-title">
      <h1>{{TITLE_HEADING}}</h1>
      <div class="badges">
        <span class="badge">API Version: <strong>{{API_VERSION}}</strong></span>
        <span class="badge">Report Date: <strong>{{REPORT_DATE}}</strong></span>
      </div>
    </div>
    <div class="brand">
      <img src="{{LOGO_HREF}}" alt="Cadence logo" />
      <a class="back" href="../index.html">← Back</a>
    </div>
  </div>
</header>

<main>
  <!-- Summary (includes Roles & Responsibilities) -->
  <section class="card" style="margin-bottom:16px">
    <h2>Summary</h2>

    <!-- Hidden raw labels so JS can derive time if Python doesn't provide -->
    <span id="prevLabel" data-label="{{PREVIOUS_LABEL}}" hidden></span>
    <span id="latestLabel" data-label="{{LATEST_LABEL}}" hidden></span>

    <!-- Dump labels with time -->
    <div class="kv">
      <div class="lbl">Previous production dump</div>
      <div class="val">{{PREVIOUS_DATE_HUMAN}} <strong id="prevTime">{{PREVIOUS_TIME_HUMAN}} PST</strong></div>
      <div class="lbl">Latest production dump</div>
      <div class="val">{{LATEST_DATE_HUMAN}} <strong id="latestTime">{{LATEST_TIME_HUMAN}} PST</strong></div>
    </div>

    <!-- Summary text with anchors -->
    <p class="note" style="margin-top:10px">
      This report compares the latest SFDC production metadata dump with the previous one, enumerating all differences—<a class="inline-link" href="#anchor-new">new files</a>, <a class="inline-link" href="#anchor-changed">changed files (content mismatches)</a>, and <a class="inline-link" href="#anchor-removed">removed files</a>. A <a class="inline-link" href="#anchor-codecomp">code comparison report</a> that provides folder-wise (metadata-type) counts and a consolidated, diff-only comparison for each metadata file.
    </p>

    <!-- Roles & Responsibilities inside the Summary card (sepia) -->
    <div class="roles-brief">
      <p style="margin:0">
        <strong>Development, DevOps,</strong> and <strong>Production Support</strong> must fill out the following columns in the
        <a class="inline-link" href="#anchor-pmfr"><strong>Production Modified File Report</strong></a> (SharePoint link):
      </p>
      <ul>
        <li>Ticket number (ID)</li>
        <li>Resolution date</li>
        <li>Module/Area</li>
        <li>Details of the change</li>
      </ul>
    </div>
  </section>

  <section class="grid" style="margin-top:16px">
    <!-- Downloads -->
    <div class="card action">
      <h2>Downloads</h2>
      <div class="btns">
        <div class="btn-wrap">
          <a id="anchor-new" class="btn green" href="{{CSV_NEW}}" download>
            <span class="left"><strong>New Files</strong></span>
            <span class="count">{{KPI_NEW}}</span>
          </a>
          <span class="info-icon" data-info="Files present in the latest production dump but absent in the previous one indicate new creations during this period in the SFDC production environment.">ⓘ</span>
        </div>

        <div class="btn-wrap">
          <a id="anchor-changed" class="btn orange" href="{{CSV_CHANGED}}" download>
            <span class="left"><strong>Changed Files</strong></span>
            <span class="count">{{KPI_CHANGED}}</span>
          </a>
          <span class="info-icon" data-info="Files present in both production dumps have undergone modifications during this period in the SFDC production environment.">ⓘ</span>
        </div>

        <div class="btn-wrap">
          <a id="anchor-removed" class="btn red" href="{{CSV_REMOVED}}" download>
            <span class="left"><strong>Removed Files</strong></span>
            <span class="count">{{KPI_REMOVED}}</span>
          </a>
          <span class="info-icon" data-info="Files missing from the latest production dump but present in the previous one indicate deletions made during this period in the SFDC production environment.">ⓘ</span>
        </div>

        <div class="btn-wrap">
          <a id="anchor-pmfr" class="btn blue" href="{{CSV_FULL}}" target="_blank" rel="noopener">
            <span class="left"><strong>Production Modified File Report</strong></span>
          </a>
          <span class="info-icon" data-info="This sheet is to be filled out by the Development, DevOps, or PS-Support teams. It should include information for each change, as specified in the sheet's columns.">ⓘ</span>
        </div>
      </div>
    </div>

    <!-- Quick Access -->
    <div class="card action">
      <h2>Quick Access</h2>
      <div class="btns">
        <a class="btn" href="{{PREVIOUS_LINK}}" target="_blank" title="Production dump taken on {{PREVIOUS_DATE_HUMAN}}">
          <span class="left"><strong>{{PREVIOUS_DATE_DASH}} Prod Dump</strong></span>
        </a>

        <a class="btn" href="{{LATEST_LINK}}" target="_blank" title="Production dump taken on {{LATEST_DATE_HUMAN}}">
          <span class="left"><strong>{{LATEST_DATE_DASH}} Prod Dump</strong></span>
        </a>

        <div class="btn-wrap">
          <a id="anchor-codecomp" class="btn" href="{{DIFF_HTML_LINK}}" target="_blank" rel="noopener">
            <span class="left"><strong>Code Comparison Report</strong></span>
          </a>
          <span class="info-icon" data-info="This report compares two production dumps and highlights only the differences, categorized by metadata type. It includes a count of changes for each metadata type.">ⓘ</span>
        </div>

        <div class="btn-wrap">
          <a id="anchor-log" class="btn" href="{{RUN_LOG_LINK}}" target="_blank" rel="noopener">
            <span class="left"><strong>Execution Log</strong></span>
          </a>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Reusable modal -->
<div class="modal-mask" id="infoMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <h3 id="infoTitle">Info</h3>
    <p id="infoBody"></p>
    <div class="actions"><button class="btn-close" id="infoClose">Close</button></div>
  </div>
</div>

<footer>This is the end of report.</footer>

<script>
  // Info modal (unchanged)
  (function(){
    const mask = document.getElementById('infoMask');
    const body = document.getElementById('infoBody');
    const title = document.getElementById('infoTitle');
    const closeBtn = document.getElementById('infoClose');

    function openModal(text, heading){
      title.textContent = heading || 'Info';
      body.textContent = text || '';
      mask.style.display = 'flex';
      mask.setAttribute('aria-hidden','false');
      closeBtn.focus();
    }
    function closeModal(){ mask.style.display='none'; mask.setAttribute('aria-hidden','true'); }

    document.addEventListener('click', function(e){
      const icon = e.target.closest('.info-icon');
      if(icon){
        const txt = icon.getAttribute('data-info') || '';
        let heading = 'Info';
        const left = icon.previousElementSibling?.querySelector?.('.left strong');
        if(left && left.textContent.trim()) heading = left.textContent.trim();
        openModal(txt, heading);
      }
      if(e.target === mask) closeModal();
    });
    closeBtn.addEventListener('click', closeModal);
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });
  })();

  // Derive AM/PM time from dump folder names if Python didn't provide it
  (function(){
    function parseTimeFromLabel(label){
      if(!label) return '';
      var m = /_(\d{1,2}):(\d{2}):(\d{2})$/.exec(label.trim());
      if(!m) return '';
      var hh = parseInt(m[1],10), mm = m[2];
      var ampm = (hh>=12)?'PM':'AM';
      hh = (hh%12)||12;
      return hh+':'+mm+' '+ampm;
    }
    function needsFill(el){
      if(!el) return false;
      var t = (el.textContent||'').trim();
      return !t || t.indexOf('{{')!==-1 || /^PST$/i.test(t) || /^{LATEST_|{PREVIOUS_/i.test(t);
    }
    var prevLabel = (document.getElementById('prevLabel')||{}).dataset?.label || '';
    var latestLabel = (document.getElementById('latestLabel')||{}).dataset?.label || '';

    var prevTimeEl = document.getElementById('prevTime');
    if(needsFill(prevTimeEl)){
      var t = parseTimeFromLabel(prevLabel);
      if(t){ prevTimeEl.textContent = t + ' PST'; }
    }
    var latestTimeEl = document.getElementById('latestTime');
    if(needsFill(latestTimeEl)){
      var t2 = parseTimeFromLabel(latestLabel);
      if(t2){ latestTimeEl.textContent = t2 + ' PST'; }
    }
  })();

  // Flash highlight the associated button for 1s after anchor clicks
  (function(){
    function flash(id){
      try{
        var el = document.querySelector(id);
        if(!el) return;
        el.classList.remove('flash'); // reset if already flashing
        // ensure scroll happens first, then flash so user sees it
        setTimeout(function(){
          el.classList.add('flash');
          setTimeout(function(){ el.classList.remove('flash'); }, 1000);
        }, 60);
      }catch(_){}
    }
    // any inline anchor in summary/roles that points to a button id
    document.addEventListener('click', function(e){
      var a = e.target.closest('a.inline-link[href^="#"]');
      if(!a) return;
      var hash = a.getAttribute('href') || '';
      if(!hash) return;
      // let default hash navigation occur; we only add a flash
      flash(hash);
    });
    // if user navigates via URL hash directly, flash as well
    window.addEventListener('hashchange', function(){
      if(location.hash) flash(location.hash);
    });
  })();
</script>
</body>
</html>

#!/bin/bash
# jbakshi@cadence.com Jan'2018
# Description: Validate changeSet against SFDC ORG + HTML email report (inline CSS)

USAGE=">>>>>  Usage: validation_git_sfcli.sh env (replace env with Sandbox or Production alias)   GitHash1 GitHash2 <<<<<<"

main() {
  Check_Lock
  Trap
  Mail_Setup
  Prepare_RunTest
  Validation
  Unlock
}

# --- arg check ---
if [ $# == 0 ] || ([ $1 != prprdnov25 ] && [ $1 != prod ] && [ $1 != dev2 ] && [ $1 != tst ] && [ $1 != sandbox ]); then
  echo -e "\n$USAGE\n"
  exit 1
fi

# --- globals ---
DATE=$(date +%d_%m_%Y_%Hh%Mm%Ss)
SFDC_ORG=$1
bin=build/script
property=build/property
buildProperty=${property}/build_${SFDC_ORG}.properties
serverProperty=${property}/${SFDC_ORG}.conf

gitlast=$2
gitlatest=$3

Logpath=build/log
mkdir -p "$Logpath"
LOCK=${Logpath}/${SFDC_ORG}.VALIDATION.LOCK
LOG=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.LOG
FAILEDTC=${Logpath}/${SFDC_ORG}.${DATE}.FAILED_TC
GITLOG=${Logpath}/${SFDC_ORG}.${DATE}.GIT.VALIDATION.LOG
TCtxt=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.txt
TCNAME=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.List
GIT_LOG=${Logpath}/${SFDC_ORG}.${DATE}.SFDC_GIT.log
CHANGESETLOG=/tmp/$SFDC_ORG.Changeset.log
DEPLOYEDFILE=/tmp/${SFDC_ORG}.Deploy.file

API=$(grep APIver "$serverProperty" | cut -d'=' -f2)

REPORT_JSON=${Logpath}/${SFDC_ORG}.${DATE}.report.json
HTMLLog=/tmp/$SFDC_ORG.Validation.log.html
HTMLFDLog=${Logpath}/${SFDC_ORG}.forceDeploy.${DATE}.html

# --- polling knobs (override in ${serverProperty}) ---
POLL_MAX_MIN=$(grep -E '^report_poll_minutes=' "$serverProperty" | cut -d'=' -f2 2>/dev/null)
POLL_SLEEP_SEC=$(grep -E '^report_poll_sleep='   "$serverProperty" | cut -d'=' -f2 2>/dev/null)
: "${POLL_MAX_MIN:=10}"      # wait up to 10 min by default
: "${POLL_SLEEP_SEC:=15}"    # poll every 15s by default
MAX_POLLS=$(( (POLL_MAX_MIN*60) / POLL_SLEEP_SEC ))
[ "$MAX_POLLS" -lt 8 ] && MAX_POLLS=8   # minimum ~2 minutes

# ============================== core funcs ==============================

Check_Lock() {
  if [ -f "$LOCK" ]; then
    echo "Another Validation process is present for $SFDC_ORG ...exit"
    mail -s "Another Validation process is present for $SFDC_ORG"  ${MAIL_LIST} < /dev/null
    exit
  else
    touch "$LOCK"
  fi
}

Prepare_RunTest() {
  rm -f "$TCNAME" "$TCtxt"
  dos2unix -n build/testClasses.txt "${TCtxt}"
  grep -v "#" "${TCtxt}" | grep -v '^\s*$' | sort -u > "$TCNAME"

  # ensure destination exists
  mkdir -p changeSetDeploy/src/classes

  # copy requested test classes into changeSetDeploy
  while IFS= read -r i; do
    [ -z "$i" ] && continue
    cp "src/classes/$i".* changeSetDeploy/src/classes/ 2>/dev/null || true
  done < "$TCNAME"

  mapfile -t TEST_CLASSES < "$TCNAME"
  TEST_FLAGS=()
  for cls in "${TEST_CLASSES[@]}"; do
    cls="${cls//$'\r'/}"
    cls="${cls##*( )}"; cls="${cls%%*( )}"
    [[ -z "$cls" ]] && continue
    TEST_FLAGS+=(--tests "$cls")
  done
}

Mail_Setup() {
  MAIL_TO=debarshi@cadence.com
  CC=$(grep email_cc ${serverProperty} | cut -d "=" -f2)
  TO=$(grep email_to ${serverProperty} | cut -d "=" -f2)
  FROM=$(grep email_from ${serverProperty} | cut -d "=" -f2)
  MAIL_LIST="-r $FROM -c $CC $TO"
  mutt_MAIL_LIST="$TO -c $CC"
  MAIL=$(grep send_email ${serverProperty} | cut -d "=" -f2)
  case ${MAIL} in
    0) MAIL_LIST=${MAIL_TO}; mutt_MAIL_LIST=${MAIL_TO} ;;
    *) ;;
  esac
}

# ============================== helpers ==============================

_esc(){ sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'; }

# single-pass file index to avoid repeated "find"
SRC_INDEX_FILE="/tmp/src_file_index.$$"
_build_src_index(){
  find src -type f -printf "%f\t%p\n" > "$SRC_INDEX_FILE" 2>/dev/null || : > "$SRC_INDEX_FILE"
}

# clean noisy tokens like:
# "Class Apttus_Agreement_File_AC : External string does not exist: CLLA"
# "src/ Class ContentDocumentTriggerHandler_AC"
_clean_token(){
  local s="$*"
  s="$(echo "$s" | tr '\t' ' ' | sed -E 's/[[:space:]]+/ /g; s/^ +| +$//g')"  # norm spaces
  s="${s%% -- *}"    # keep left of " -- "
  s="${s%%:*}"       # keep left of first colon
  s="${s%%|*}"       # keep left of pipe
  s="${s#src/}"      # drop src/
  s="$(echo "$s" | sed -E 's#^(Class|Trigger|Apex( class)?|src|/)+[[:space:]]+##I')" # drop noisy lead
  s="$(echo "$s" | sed -E 's/[[:space:]]+line[[:space:]]+[0-9]+.*$//I')"            # drop "line 23.."
  s="$(echo "$s" | sed -E 's/^ +| +$//g')"                                          # final trim
  echo "$s"
}

_guess_dir_for_token(){
  case "$1" in
    *.cls|*Class*|*Handler*|*Controller*) echo "classes" ;;
    *.trigger|*Trigger*)                  echo "triggers" ;;
    *.page)                               echo "pages" ;;
    *.component)                          echo "components" ;;
    *.flexipage|*Flexi*|*Lightning*)      echo "flexipages" ;;
    *.app|*Application*)                  echo "applications" ;;
    *.permissionset|*Permission*)         echo "permissionsets" ;;
    *.workflow|*Workflow*)                echo "workflows" ;;
    *.layout|*Layout*)                    echo "layouts" ;;
    *.object|*__c|*__mdt|*Object*)        echo "objects" ;;
    *flow*|*Flow*)                        echo "flows" ;;
    *RemoteSite*|*remoteSite*)            echo "remoteSiteSettings" ;;
    *Label*|*labels*)                     echo "labels" ;;
    *)                                    echo "" ;;
  esac
}

# resolve token → list of plausible repo paths
_resolve_files(){
  local token raw base dir
  raw="$*"
  token="$(_clean_token "$raw")"
  base="${token##*/}"
  base="${base%-meta.xml}"

  dir="$(_guess_dir_for_token "$token")"
  local matches=()

  # index lookup (fast)
  if [ -s "$SRC_INDEX_FILE" ]; then
    if [ -n "$dir" ]; then
      mapfile -t matches < <(awk -v b="$base" -v d="/$dir/" -F'\t' '
        index($2,d) && ($1==b || index($1,b)==1) { print length($2), $2 }' "$SRC_INDEX_FILE" \
        | sort -n | cut -d" " -f2-)
    fi
    if [ "${#matches[@]}" -eq 0 ]; then
      mapfile -t matches < <(awk -v b="$base" -F'\t' '
        ($1==b || index($1,b)==1) { print length($2), $2 }' "$SRC_INDEX_FILE" \
        | sort -n | cut -d" " -f2-)
    fi
  fi

  # narrow find in guessed dir
  if [ "${#matches[@]}" -eq 0 ] && [ -n "$dir" ] && [ -d "src/$dir" ]; then
    mapfile -t matches < <(find "src/$dir" -type f \( -name "${base}*" -o -name "*${base}*" \) 2>/dev/null \
      | awk '{ print length, $0 }' | sort -n | cut -d" " -f2-)
  fi

  # global find
  if [ "${#matches[@]}" -eq 0 ]; then
    mapfile -t matches < <(find src -type f \( -name "${base}*" -o -name "*${base}*" \) 2>/dev/null \
      | awk '{ print length, $0 }' | sort -n | cut -d" " -f2-)
  fi

  # labels fallback
  if [ "${#matches[@]}" -eq 0 ] && [[ "$base" =~ ^CustomLabels(\.labels)?$ ]]; then
    matches=("env/${SFDC_ORG}/customLabel/CustomLabels.labels-meta.xml")
  fi

  printf '%s\n' "${matches[@]}"
}

# print last 2 commits for best-matching path(s), pref non-meta over meta
_gitlog_for_component(){
  local token="$*"
  local resolved=()
  mapfile -t resolved < <(_resolve_files "$token")

  if [ "${#resolved[@]}" -eq 0 ]; then
    echo "Latest 2 GIT log >>> (not found): $token"
    echo "Hint: file may be generated/renamed or in a subfolder; searched by prefix and common metadata suffixes."
    return
  fi

  local preferred=() meta=()
  local f
  for f in "${resolved[@]}"; do
    if [[ "$f" =~ -meta\.xml$ ]]; then meta+=("$f"); else preferred+=("$f"); fi
  done
  local ordered=( "${preferred[@]}" "${meta[@]}" )

  local shown=0
  for f in "${ordered[@]}"; do
    echo "Latest 2 GIT log >>> ${f}"
    if [ -f "$f" ]; then
      git --no-pager log -2 --date=short --pretty='format:%h %ad %an %s' -- "$f" \
        | sed 's/$/ |/' | paste -sd' ' -
    else
      echo "(exists-in-index? Could not read path: $f)"
    fi
    shown=$((shown+1))
    [ $shown -ge 3 ] && break
  done
}

# ============================== deploy & report ==============================

Validation() {
  sf project deploy validate \
      --source-dir changeSetDeploy \
      --test-level RunSpecifiedTests \
      "${TEST_FLAGS[@]}" \
      --target-org "$SFDC_ORG" \
      --wait 60 \
      --json > "${LOG}.initial.json" 2> "${LOG}.err"

  cat "${LOG}.err" > "$LOG"
  cat "${LOG}.initial.json" >> "$LOG"

  INITIAL_STATUS=$(jq -r '.status' "${LOG}.initial.json" 2>/dev/null)
  if [ "$INITIAL_STATUS" == "0" ]; then
    cp "${LOG}.initial.json" "$REPORT_JSON"
    antReturnCode="DEPLOYMENT SUCCEEDED"
  else
    ERROR_NAME=$(jq -r '.name' "${LOG}.initial.json" 2>/dev/null)
    if [ "$ERROR_NAME" == "FailedValidationError" ]; then
      DEPLOY_ID=$(jq -r '.data.deployId' "${LOG}.initial.json" 2>/dev/null)
      if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
        echo "[ERROR] No deploy ID found in initial output" | tee -a "$LOG"
        antReturnCode="Request Status: Failed"
      else
        # fetch & bounded poll
        sf project deploy report --job-id "$DEPLOY_ID" --target-org "$SFDC_ORG" --json > "$REPORT_JSON" 2> "${LOG}.err"
        cat "${LOG}.err" >> "$LOG"

        START_TS=$(date +%s)
        POLL_COUNT=0
        while : ; do
          RESULT_STATUS=$(jq -r '.result.status // .status // empty' "$REPORT_JSON" 2>/dev/null)
          [ "$RESULT_STATUS" != "InProgress" ] && break

          [ "$POLL_COUNT" -ge "$MAX_POLLS" ] && { echo "[INFO] Poll cap reached after ${POLL_COUNT} polls." >> "$LOG"; break; }

          jq -r '[
              "status=\(.result.status // .status // "n/a")",
              "tests=\((.result.numberTestsCompleted // 0)|tostring)/\((.result.numberTestsTotal // 0)|tostring)",
              "comp=\((.result.numberComponentsDeployed // 0)|tostring)/\((.result.numberComponentsTotal // 0)|tostring)"
            ] | join(" ")' "$REPORT_JSON" 2>/dev/null | sed "s/^/[PROGRESS] /" >> "$LOG"

          sleep "$POLL_SLEEP_SEC"
          ((POLL_COUNT++))
          sf project deploy report --job-id "$DEPLOY_ID" --target-org "$SFDC_ORG" --json > "$REPORT_JSON" 2> "${LOG}.err"
          cat "${LOG}.err" >> "$LOG"
        done

        ELAPSED=$(( $(date +%s) - START_TS ))
        echo "[INFO] Report fetch finished with status=${RESULT_STATUS} in ${ELAPSED}s (polls=${POLL_COUNT})." >> "$LOG"

        if   [ "$RESULT_STATUS" == "Failed" ];     then antReturnCode="Request Status: Failed"
        elif [ "$RESULT_STATUS" == "Succeeded" ];  then antReturnCode="DEPLOYMENT SUCCEEDED"
        elif [ "$RESULT_STATUS" == "InProgress" ]; then antReturnCode="Failed to obtain result from server within specified time"
        else antReturnCode="Request Status: Failed"
        fi
      fi
    elif jq -r '.message' "${LOG}.initial.json" 2>/dev/null | grep -iq "locked"; then
      antReturnCode="ALREADY_IN_PROCESS"
    else
      antReturnCode="Failed to obtain result from server within specified time"
    fi
  fi

  # filtered human log (safe if array-or-object)
  if [ -s "$REPORT_JSON" ]; then
    jq -r '.result.details | {componentFailures, runTestResult: {failures, codeCoverageWarnings}}' "$REPORT_JSON" > "${LOG}.filtered.json" 2>/dev/null || true
    jq -r 'to_entries | map("\(.key): \(.value)") | join("\n")' "${LOG}.filtered.json" > "${LOG}.filtered" 2>/dev/null || true
  else
    jq -r '.message // "No report.json available; see error log."' "${LOG}.initial.json" > "${LOG}.filtered" 2>/dev/null || echo "No JSON output captured." > "${LOG}.filtered"
  fi

  case $antReturnCode in
    "DEPLOYMENT SUCCEEDED") HTML_Report SUCCEEDED; PublishLOG changeset ;;
    "ALREADY_IN_PROCESS")   HTML_Report LOCKED;    PublishLOG changeset ;;
    "Request Status: Failed"|"Failed to obtain result from server within specified time")
                            HTML_Report FAILED;    PublishLOG changeset ;;
  esac
}

# ============================== HTML Report (inline CSS) ==============================

HTML_Report(){
  Report=$1

  # prepare detail files (array-or-object tolerant + sanitized)
  if [ -s "$REPORT_JSON" ]; then
    jq -r '
      (.result.details.componentFailures // empty)
      | (if type=="array" then . else [.] end)
      | .[]
      | "\(.fileName) -- \(.problem|tostring|gsub("[\r\n\t]";" "))"
    ' "$REPORT_JSON" > "${LOG}.component_failures" 2>/dev/null || : > "${LOG}.component_failures"

    jq -r '
      (.result.details.runTestResult.failures // empty)
      | (if type=="array" then . else [.] end)
      | .[]
      | [ .name, .methodName,
          (.message|tostring|gsub("[\r\n\t]";" ")),
          (.stackTrace|tostring|gsub("[\r\n\t]";" "))
        ]
      | @tsv
    ' "$REPORT_JSON" > "${LOG}.test_failures" 2>/dev/null || : > "${LOG}.test_failures"

    jq -r '
      (.result.details.runTestResult.codeCoverageWarnings // empty)
      | (if type=="array" then . else [.] end)
      | .[]
      | [ .name, (.message|tostring|gsub("[\r\n\t]";" ")) ]
      | @tsv
    ' "$REPORT_JSON" > "${LOG}.code_coverage_warnings" 2>/dev/null || : > "${LOG}.code_coverage_warnings"
  else
    : > "${LOG}.component_failures"
    : > "${LOG}.test_failures"
    : > "${LOG}.code_coverage_warnings"
  fi

  comp_count=$(wc -l < "${LOG}.component_failures" 2>/dev/null || echo 0)
  test_count=$(wc -l < "${LOG}.test_failures" 2>/dev/null || echo 0)
  cov_count=$(wc -l < "${LOG}.code_coverage_warnings" 2>/dev/null || echo 0)
  REQ_ID=$(jq -r '(.result.id // .id // .data.deployId // "N/A")' "$REPORT_JSON" 2>/dev/null || echo "N/A")

  SAVEIFS=$IFS
  IFS=$(echo -en "\n\b")

  # build index once for speed
  _build_src_index

  # --- Email body (inline CSS) ---
  # NOTE: table-based layout; minimal styles for email clients
  cat > "$HTMLLog" <<EOF
<!DOCTYPE html>
<html>
<body style="margin:0;padding:0;background:#f7f7f9;font-family:Segoe UI,Arial,Helvetica,sans-serif;color:#222;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
    <tr>
      <td>
        <table align="center" width="980" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;margin:16px auto;background:#ffffff;border:1px solid #e5e7eb;">
          <!-- Header bar -->
          <tr>
            <td style="background:#111827;color:#ffffff;padding:14px 18px;font-size:18px;font-weight:600;letter-spacing:.2px;">
              ${SFDC_ORG} ChangeSet Validation ${Report}
            </td>
          </tr>

          <!-- quick links / meta -->
          <tr>
            <td style="padding:12px 18px;border-bottom:1px solid #f0f0f0;">
              <span style="display:inline-block;margin-right:16px;font-size:13px;">
                <b>API:</b> ${API}
              </span>
              <span style="display:inline-block;margin-right:16px;font-size:13px;">
                <b>Request ID:</b> ${REQ_ID}
              </span>
              <span style="display:inline-block;margin-right:16px;font-size:13px;">
                <b>Git Range:</b> ${gitlast} → ${gitlatest}
              </span>
              <div style="margin-top:8px;">
                <a href="https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}" style="font-size:13px;text-decoration:none;color:#2563eb;">Log and changeset</a>
                <span style="color:#9ca3af;">&nbsp;•&nbsp;</span>
                <a href="https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}/${SFDC_ORG}.changesetList.${DATE}.html" style="font-size:13px;text-decoration:none;color:#2563eb;">Changeset List</a>
                <span style="color:#9ca3af;">&nbsp;•&nbsp;</span>
                <a href="https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}/${HTMLFDLog##*/}" style="font-size:13px;text-decoration:none;color:#2563eb;">ForceDeploy</a>
              </div>
            </td>
          </tr>

          <!-- summary tiles -->
          <tr>
            <td style="padding:14px 18px;">
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
                <tr>
                  <td style="width:33.33%;padding:10px;">
                    <div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;background:#f9fafb;">
                      <div style="font-size:12px;color:#6b7280;">Component Failures</div>
                      <div style="font-size:20px;font-weight:700;margin-top:4px;color:#b91c1c;">${comp_count}</div>
                    </div>
                  </td>
                  <td style="width:33.33%;padding:10px;">
                    <div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;background:#f9fafb;">
                      <div style="font-size:12px;color:#6b7280;">Test Failures</div>
                      <div style="font-size:20px;font-weight:700;margin-top:4px;color:#b91c1c;">${test_count}</div>
                    </div>
                  </td>
                  <td style="width:33.33%;padding:10px;">
                    <div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;background:#f9fafb;">
                      <div style="font-size:12px;color:#6b7280;">Coverage Warnings</div>
                      <div style="font-size:20px;font-weight:700;margin-top:4px;color:#ca8a04;">${cov_count}</div>
                    </div>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- sections start -->
EOF

  # SUCCEEDED note
  if [ "${Report}" = "SUCCEEDED" ]; then
    echo "          <tr><td style=\"padding:10px 18px 6px 18px;font-size:14px;color:#065f46;background:#ecfdf5;border-top:1px solid #d1fae5;\">Deployment validated successfully.</td></tr>" >> "$HTMLLog"
  fi

  # FAILED/LOCKED: details
  if [ "${Report}" = "FAILED" ] || [ "${Report}" = "LOCKED" ]; then
    # Component Failures
    if [ "$comp_count" -gt 0 ]; then
      echo "          <tr><td style=\"padding:8px 18px;\"><div style=\"font-size:15px;font-weight:600;margin:8px 0 6px 0;\">Component Failures</div></td></tr>" >> "$HTMLLog"
      while IFS= read -r LINE; do
        FILE=$(echo "$LINE" | awk -F ' -- ' '{print $1}')
        echo "          <tr><td style=\"padding:0 18px 8px 18px;\">" >> "$HTMLLog"
        echo "            <div style=\"border:1px solid #fee2e2;background:#fff7f7;border-radius:6px;padding:8px 10px;margin:6px 0;\">" >> "$HTMLLog"
        echo "              <div style=\"font-family:monospace;font-size:12px;color:#b91c1c;\">" >> "$HTMLLog"
        echo "$(echo "$LINE" | _esc)" >> "$HTMLLog"
        echo "              </div>" >> "$HTMLLog"
        echo "              <div style=\"margin-top:6px;padding:6px 8px;border:1px solid #e5e7eb;background:#f9fafb;border-radius:4px;\">" >> "$HTMLLog"
        _gitlog_for_component "${FILE}" | _esc >> "$HTMLLog"
        echo "              </div>" >> "$HTMLLog"
        echo "            </div>" >> "$HTMLLog"
        echo "          </td></tr>" >> "$HTMLLog"
      done < "${LOG}.component_failures"
    fi

    # Test Failures
    echo "          <tr><td style=\"padding:8px 18px;\"><div style=\"font-size:15px;font-weight:600;margin:12px 0 6px 0;\">${SFDC_ORG} Test Class</div></td></tr>" >> "$HTMLLog"
    if [ "$test_count" -gt 0 ]; then
      idx=1
      while IFS=$'\t' read -r CLASS METHOD MSG STACK; do
        [ -z "$CLASS" ] && continue
        echo "          <tr><td style=\"padding:0 18px 8px 18px;\">" >> "$HTMLLog"
        echo "            <div style=\"border:1px solid #fde68a;background:#fffbeb;border-radius:6px;padding:8px 10px;margin:6px 0;\">" >> "$HTMLLog"
        echo "              <div style=\"font-size:13px;\"><b>${idx}. $(echo "${CLASS}.${METHOD}()" | _esc)</b></div>" >> "$HTMLLog"
        echo "              <div style=\"font-size:12px;margin-top:4px;color:#374151;\">$(echo "Error: ${MSG}" | _esc)</div>" >> "$HTMLLog"
        echo "              <div style=\"font-size:12px;margin-top:2px;color:#6b7280;font-family:monospace;\">$(echo "StackTrace: ${STACK}" | _esc)</div>" >> "$HTMLLog"
        echo "              <div style=\"margin-top:8px;padding:6px 8px;border:1px solid #e5e7eb;background:#f9fafb;border-radius:4px;\">" >> "$HTMLLog"
        _gitlog_for_component "${CLASS}" | _esc >> "$HTMLLog"
        echo "              </div>" >> "$HTMLLog"
        echo "            </div>" >> "$HTMLLog"
        echo "          </td></tr>" >> "$HTMLLog"
        ((idx++))
      done < "${LOG}.test_failures"
    else
      echo "          <tr><td style=\"padding:0 18px 12px 18px;color:#6b7280;font-size:13px;\">No test failures.</td></tr>" >> "$HTMLLog"
    fi

    # Code Coverage Warnings
    echo "          <tr><td style=\"padding:8px 18px;\"><div style=\"font-size:15px;font-weight:600;margin:12px 0 6px 0;\">${SFDC_ORG} Code Coverage</div></td></tr>" >> "$HTMLLog"
    if [ "$cov_count" -gt 0 ]; then
      cov_idx=1
      while IFS=$'\t' read -r NAME MESSAGE; do
        [ -z "$NAME" ] && continue
        echo "          <tr><td style=\"padding:0 18px 8px 18px;\">" >> "$HTMLLog"
        echo "            <div style=\"border:1px solid #fee2e2;background:#fff7f7;border-radius:6px;padding:8px 10px;margin:6px 0;\">" >> "$HTMLLog"
        echo "              <div style=\"font-size:13px;\"><b>${cov_idx}. $(echo "$NAME" | _esc)</b></div>" >> "$HTMLLog"
        echo "              <div style=\"font-size:12px;margin-top:4px;color:#374151;\">$(echo "Warning: ${MESSAGE}" | _esc)</div>" >> "$HTMLLog"
        echo "              <div style=\"margin-top:8px;padding:6px 8px;border:1px solid #e5e7eb;background:#f9fafb;border-radius:4px;\">" >> "$HTMLLog"
        _gitlog_for_component "${NAME}" | _esc >> "$HTMLLog"
        echo "              </div>" >> "$HTMLLog"
        echo "            </div>" >> "$HTMLLog"
        echo "          </td></tr>" >> "$HTMLLog"
        ((cov_idx++))
      done < "${LOG}.code_coverage_warnings"
    else
      echo "          <tr><td style=\"padding:0 18px 12px 18px;color:#6b7280;font-size:13px;\">No coverage warnings.</td></tr>" >> "$HTMLLog"
    fi
  fi

  # Changeset list (always)
  echo "          <tr><td style=\"padding:8px 18px;\"><div style=\"font-size:15px;font-weight:600;margin:14px 0 6px 0;\">Changeset file/s &nbsp;...&nbsp; [$(find changeSetDeploy -type f | egrep -v "package.xml|staticResourceFolders.txt" | wc -l)]</div></td></tr>" >> "$HTMLLog"

  # build deployed file list
  find changeSetDeploy -type f | egrep -v "package.xml|staticResourceFolders.txt" | cut -d "/" -f  1,2 --complement | sort -u > "${DEPLOYEDFILE}"

  NUM=1
  while IFS= read -r FILE; do
    [ -z "$FILE" ] && continue
    if [ "${FILE}" == "labels/CustomLabels.labels-meta.xml" ]; then
      FILE="env/${SFDC_ORG}/customLabel/CustomLabels.labels-meta.xml"
    elif [[ "${FILE}" =~ remoteSiteSettings/ ]]; then
      FILE=$(echo "${FILE}" | sed -e "s/^env\/${SFDC_ORG}//g")
    elif [[ "${FILE}" =~ src/customMetadata/ ]]; then
      FILE=$(echo "${FILE}" | sed -e "s/^env\/${SFDC_ORG}//g")
    fi

    echo "          <tr><td style=\"padding:0 18px 8px 18px;\">" >> "$HTMLLog"
    echo "            <div style=\"border:1px solid #e5e7eb;background:#f9fafb;border-radius:6px;padding:8px 10px;margin:6px 0;\">" >> "$HTMLLog"
    echo "              <div style=\"font-family:monospace;font-size:12px;color:#111827;\">[$((NUM++))] $(echo "${FILE}" | _esc)</div>" >> "$HTMLLog"

    LastAuthor="$(
      _resolve_files "${FILE}" | head -n1 | while read -r p; do
        if [ -f "$p" ]; then
          git --no-pager log -1 --date=short --pretty='format:%h %ad %an %s' -- "$p"
        fi
        break
      done
    )"

    echo "              <div style=\"margin-top:6px;padding:6px 8px;border:1px dashed #d1d5db;background:#ffffff;border-radius:4px;font-size:12px;\">$(echo "Last author... ${LastAuthor}" | _esc)</div>" >> "$HTMLLog"
    echo "            </div>" >> "$HTMLLog"
    echo "          </td></tr>" >> "$HTMLLog"
  done < "${DEPLOYEDFILE}"

  # footer
  cat >> "$HTMLLog" <<EOF
          <tr>
            <td style="padding:14px 18px;color:#6b7280;font-size:12px;border-top:1px solid #f0f0f0;background:#fafafa;">
              Generated: $(date +"%d %b %Y, %H:%M %Z") &nbsp;•&nbsp; Org: ${SFDC_ORG} &nbsp;•&nbsp; API ${API}
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
EOF

  EMAIL=${FROM} mutt -e 'set content_type=text/html' \
    -s "---${SFDC_ORG}---ChangeSet Validation ${Report} [$(date +%d.%b.%Y) PST - git ${gitlast}-${gitlatest} ]" \
    ${mutt_MAIL_LIST} -a "$LOG.filtered" < "$HTMLLog"

  IFS=$SAVEIFS
}

# ============================== Changeset publish (unchanged) ==============================

CHNGSETLIST (){
  ORGchngSet=${SFDC_ORG}.${DATE}.changeSetDeploy
  ORGchngSetFILE=${Logpath}/${SFDC_ORG}.changesetList.${DATE}
  cp -r changeSetDeploy  ${ORGchngSet}
  if [ -d ${ORGchngSet}/src/staticresources ]; then
    cd ${ORGchngSet}
    bash ${bin}/staticresource_decompress.sh
  fi
  cd - >/dev/null 2>&1 || true
  find ${ORGchngSet}/customSettings/src/env/ ${ORGchngSet}/src/ -type f \
    | egrep -v  "package.xml|staticResourceFolders.txt" \
    | cut -d "/" -f3-20 | sort > ${ORGchngSetFILE}.csv
  sed -e "s/$/<br><br>/ ;1 i<HTML>\n<BODY>" ${ORGchngSetFILE}.csv >  ${ORGchngSetFILE}.html
  sed -i "\$a</BODY>\n</HTML>" ${ORGchngSetFILE}.html
}

PublishLOG(){
  LogStorePath="/data/public/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}"
  mkdir -p ${LogStorePath}
  if [ "$1" == "changeset" ]; then
    cp ${CHANGESETLOG} ${LogStorePath}/$SFDC_ORG.Changeset.log.${DATE} 2>/dev/null || true
    cp ${LOG} ${LogStorePath}/$SFDC_ORG.Deploy.log.${DATE} 2>/dev/null || true
    cp ${HTMLLog} ${LogStorePath}/${SFDC_ORG}.Deploy.log.${DATE}.html 2>/dev/null || true
    cp -r changeSetDeploy ${LogStorePath}/${SFDC_ORG}.changeSetDeploy.${DATE} 2>/dev/null || true
    cp ${ORGchngSetFILE}.html  ${ORGchngSetFILE}.csv ${LogStorePath}/ 2>/dev/null || true
    cp $REPORT_JSON ${LogStorePath}/ 2>/dev/null || true
  fi
}

Unlock(){ rm -f "$LOCK"; }
Trap(){ trap Unlock SIGINT; }
FAIL_EXIT(){ rm -f "$LOCK"; exit; }

# ============================== entry ==============================
main "$@"

#!/bin/bash
# jbakshi@cadence.com Jan'2018
# Description: Validate changeset against SFDC ORG + HTML email report (colored, numbered) + git authors

USAGE=">>>>>  Usage: validation_git_sfcli.sh env (replace env with Sandbox or Production alias)   GitHash1 GitHash2 <<<<<<"

main() {
  Check_Lock
  Trap
  Mail_Setup
  Prepare_RunTest
  Validation
  Unlock
}

# --- arg check ---
if [ $# == 0 ] || ([ $1 != prprdnov25 ] && [ $1 != prod ] && [ $1 != dev2 ] && [ $1 != tst ] && [ $1 != sandbox ]); then
  echo -e "\n$USAGE\n"
  exit 1
fi

# --- globals ---
DATE=$(date +%d_%m_%Y_%Hh%Mm%Ss)
SFDC_ORG=$1
bin=build/script
property=build/property
buildProperty=${property}/build_${SFDC_ORG}.properties
serverProperty=${property}/${SFDC_ORG}.conf

gitlast=$2
gitlatest=$3

Logpath=build/log
mkdir -p "$Logpath"
LOCK=${Logpath}/${SFDC_ORG}.VALIDATION.LOCK
LOG=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.LOG
FAILEDTC=${Logpath}/${SFDC_ORG}.${DATE}.FAILED_TC
GITLOG=${Logpath}/${SFDC_ORG}.${DATE}.GIT.VALIDATION.LOG
TCtxt=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.txt
TCNAME=${Logpath}/${SFDC_ORG}.${DATE}.VALIDATION.List
GIT_LOG=${Logpath}/${SFDC_ORG}.${DATE}.SFDC_GIT.log
CHANGESETLOG=/tmp/$SFDC_ORG.Changeset.log
DEPLOYEDFILE=/tmp/${SFDC_ORG}.Deploy.file

API=$(grep APIver "$serverProperty" | cut -d'=' -f2)

REPORT_JSON=${Logpath}/${SFDC_ORG}.${DATE}.report.json
HTMLLog=/tmp/$SFDC_ORG.Validation.log.html
HTMLFDLog=${Logpath}/${SFDC_ORG}.forceDeploy.${DATE}.html

# TSVs used by the renderer (and attached for debugging)
COMPONENT_TSV=${Logpath}/${SFDC_ORG}.${DATE}.component_failures.tsv
TEST_TSV=${Logpath}/${SFDC_ORG}.${DATE}.test_failures.tsv
COV_TSV=${Logpath}/${SFDC_ORG}.${DATE}.codecov.tsv

# --- polling knobs (configurable via ${serverProperty}) ---
POLL_MAX_MIN=$(grep -E '^report_poll_minutes=' "$serverProperty" | cut -d'=' -f2 2>/dev/null)
POLL_SLEEP_SEC=$(grep -E '^report_poll_sleep=' "$serverProperty" | cut -d'=' -f2 2>/dev/null)
: "${POLL_MAX_MIN:=10}"      # default: wait up to 10 minutes total
: "${POLL_SLEEP_SEC:=15}"    # default: poll every 15 seconds
MAX_POLLS=$(( (POLL_MAX_MIN*60) / POLL_SLEEP_SEC ))
[ "$MAX_POLLS" -lt 8 ] && MAX_POLLS=8   # minimum ~2 minutes

# ============================== core funcs ==============================

Check_Lock() {
  if [ -f "$LOCK" ]; then
    echo "Another Validation process is present for $SFDC_ORG ...exit"
    mail -s "Another Validation process is present for $SFDC_ORG" ${MAIL_LIST} < /dev/null
    exit
  else
    touch "$LOCK"
  fi
}

Prepare_RunTest() {
  rm -f "$TCNAME" "$TCtxt"
  dos2unix -n build/testClasses.txt "${TCtxt}"
  grep -v "#" "${TCtxt}" | grep -v '^\s*$' | sort -u > "$TCNAME"

  mkdir -p changeSetDeploy/src/classes

  while IFS= read -r i; do
    [ -z "$i" ] && continue
    cp "src/classes/$i".* changeSetDeploy/src/classes/ 2>/dev/null || true
  done < "$TCNAME"

  mapfile -t TEST_CLASSES < "$TCNAME"
  TEST_FLAGS=()
  for cls in "${TEST_CLASSES[@]}"; do
    cls="${cls//$'\r'/}"
    cls="${cls##*( )}"; cls="${cls%%*( )}"
    [[ -z "$cls" ]] && continue
    TEST_FLAGS+=(--tests "$cls")
  done
}

Mail_Setup() {
  MAIL_TO=debarshi@cadence.com
  CC=$(grep email_cc ${serverProperty} | cut -d "=" -f2)
  TO=$(grep email_to ${serverProperty} | cut -d "=" -f2)
  FROM=$(grep email_from ${serverProperty} | cut -d "=" -f2)
  MAIL_LIST="-r $FROM -c $CC $TO"
  mutt_MAIL_LIST="$TO -c $CC"
  MAIL=$(grep send_email ${serverProperty} | cut -d "=" -f2)
  case ${MAIL} in
    0) MAIL_LIST=${MAIL_TO}; mutt_MAIL_LIST=${MAIL_TO} ;;
    *) ;;
  esac
}

# ============================== helpers ==============================

_esc(){ sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'; }

# Fast single-pass file index to avoid repeated 'find'
SRC_INDEX_FILE="/tmp/src_file_index.$$"
_build_src_index(){
  find src -type f -printf "%f\t%p\n" > "$SRC_INDEX_FILE" 2>/dev/null || : > "$SRC_INDEX_FILE"
}

_clean_token(){
  local s="$*"
  s="$(echo "$s" | tr '\t' ' ' | sed -E 's/[[:space:]]+/ /g; s/^ +| +$//g')"
  s="${s%% -- *}"; s="${s%%:*}"; s="${s%%|*}"
  s="${s#src/}"
  s="$(echo "$s" | sed -E 's#^(Class|Trigger|Apex( class)?|src|/)+[[:space:]]+##I')"
  s="$(echo "$s" | sed -E 's/[[:space:]]+line[[:space:]]+[0-9]+.*$//I')"
  s="$(echo "$s" | sed -E 's/^ +| +$//g')"
  echo "$s"
}

_guess_dir_for_token(){
  case "$1" in
    *.cls|*Class*|*Handler*|*Controller*) echo "classes" ;;
    *.trigger|*Trigger*)                  echo "triggers" ;;
    *.page)                               echo "pages" ;;
    *.component)                          echo "components" ;;
    *.flexipage|*Flexi*|*Lightning*)      echo "flexipages" ;;
    *.app|*Application*)                  echo "applications" ;;
    *.permissionset|*Permission*)         echo "permissionsets" ;;
    *.workflow|*Workflow*)                echo "workflows" ;;
    *.layout|*Layout*)                    echo "layouts" ;;
    *.object|*__c|*__mdt|*Object*)        echo "objects" ;;
    *flow*|*Flow*)                        echo "flows" ;;
    *RemoteSite*|*remoteSite*)            echo "remoteSiteSettings" ;;
    *Label*|*labels*)                     echo "labels" ;;
    *)                                    echo "" ;;
  esac
}

_resolve_files(){
  local token raw base dir
  raw="$*"
  token="$(_clean_token "$raw")"
  base="${token##*/}"
  base="${base%-meta.xml}"

  dir="$(_guess_dir_for_token "$token")"
  local matches=()

  if [ -s "$SRC_INDEX_FILE" ]; then
    if [ -n "$dir" ]; then
      mapfile -t matches < <(awk -v b="$base" -v d="/$dir/" -F'\t' '
        index($2,d) && ($1==b || index($1,b)==1) { print length($2), $2 }' "$SRC_INDEX_FILE" \
        | sort -n | cut -d" " -f2-)
    fi
    if [ "${#matches[@]}" -eq 0 ]; then
      mapfile -t matches < <(awk -v b="$base" -F'\t' '
        ($1==b || index($1,b)==1) { print length($2), $2 }' "$SRC_INDEX_FILE" \
        | sort -n | cut -d" " -f2-)
    fi
  fi

  if [ "${#matches[@]}" -eq 0 ] && [ -n "$dir" ] && [ -d "src/$dir" ]; then
    mapfile -t matches < <(find "src/$dir" -type f \( -name "${base}*" -o -name "*${base}*" \) 2>/dev/null \
      | awk '{ print length, $0 }' | sort -n | cut -d" " -f2-)
  fi
  if [ "${#matches[@]}" -eq 0 ]; then
    mapfile -t matches < <(find src -type f \( -name "${base}*" -o -name "*${base}*" \) 2>/dev/null \
      | awk '{ print length, $0 }' | sort -n | cut -d" " -f2-)
  fi

  if [ "${#matches[@]}" -eq 0 ] && [[ "$base" =~ ^CustomLabels(\.labels)?$ ]]; then
    matches=("env/${SFDC_ORG}/customLabel/CustomLabels.labels-meta.xml")
  fi

  printf '%s\n' "${matches[@]}"
}

_gitlog_for_component(){
  local token="$*"
  local resolved=()
  mapfile -t resolved < <(_resolve_files "$token")

  if [ "${#resolved[@]}" -eq 0 ]; then
    echo "Git Log --> (not found)"
    return
  fi

  local preferred=() meta=()
  local f
  for f in "${resolved[@]}"; do
    if [[ "$f" =~ -meta\.xml$ ]]; then meta+=("$f"); else preferred+=("$f"); fi
  done
  local ordered=( "${preferred[@]}" "${meta[@]}" )

  local shown=0
  for f in "${ordered[@]}"; do
    echo "Git Log --> ${f}"
    if [ -f "$f" ]; then
      git --no-pager log -2 --date=short --pretty='format:%h %ad %an %s' -- "$f" \
        | sed 's/$/ |/' | paste -sd' ' -
    else
      echo "(path not readable)"
    fi
    shown=$((shown+1))
    [ $shown -ge 3 ] && break
  done
}

# ============================== deploy & report ==============================

Validation() {
  sf project deploy validate \
      --source-dir changeSetDeploy \
      --test-level RunSpecifiedTests \
      "${TEST_FLAGS[@]}" \
      --target-org "$SFDC_ORG" \
      --wait 60 \
      --json > "${LOG}.initial.json" 2> "${LOG}.err"

  cat "${LOG}.err" > "$LOG"
  cat "${LOG}.initial.json" >> "$LOG"

  INITIAL_STATUS=$(jq -r '.status' "${LOG}.initial.json" 2>/dev/null)
  if [ "$INITIAL_STATUS" == "0" ]; then
    cp "${LOG}.initial.json" "$REPORT_JSON"
    antReturnCode="DEPLOYMENT SUCCEEDED"
  else
    ERROR_NAME=$(jq -r '.name' "${LOG}.initial.json" 2>/dev/null)
    if [ "$ERROR_NAME" == "FailedValidationError" ]; then
      DEPLOY_ID=$(jq -r '.data.deployId' "${LOG}.initial.json" 2>/dev/null)
      if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
        echo "[ERROR] No deploy ID found in initial output" | tee -a "$LOG"
        antReturnCode="Request Status: Failed"
      else
        sf project deploy report --job-id "$DEPLOY_ID" --target-org "$SFDC_ORG" --json > "$REPORT_JSON" 2> "${LOG}.err"
        cat "${LOG}.err" >> "$LOG"

        START_TS=$(date +%s)
        POLL_COUNT=0
        while : ; do
          RESULT_STATUS=$(jq -r '.result.status // .status // empty' "$REPORT_JSON" 2>/dev/null)
          [ "$RESULT_STATUS" != "InProgress" ] && break

          [ "$POLL_COUNT" -ge "$MAX_POLLS" ] && { echo "[INFO] Poll cap reached after ${POLL_COUNT} polls." >> "$LOG"; break; }

          jq -r '[
              "status=\(.result.status // .status // "n/a")",
              "tests=\((.result.numberTestsCompleted // 0)|tostring)/\((.result.numberTestsTotal // 0)|tostring)",
              "comp=\((.result.numberComponentsDeployed // 0)|tostring)/\((.result.numberComponentsTotal // 0)|tostring)"
            ] | join(" ")' "$REPORT_JSON" 2>/dev/null | sed "s/^/[PROGRESS] /" >> "$LOG"

          sleep "$POLL_SLEEP_SEC"
          ((POLL_COUNT++))
          sf project deploy report --job-id "$DEPLOY_ID" --target-org "$SFDC_ORG" --json > "$REPORT_JSON" 2> "${LOG}.err"
          cat "${LOG}.err" >> "$LOG"
        done

        ELAPSED=$(( $(date +%s) - START_TS ))
        echo "[INFO] Report fetch finished with status=${RESULT_STATUS} in ${ELAPSED}s (polls=${POLL_COUNT})." >> "$LOG"

        if   [ "$RESULT_STATUS" == "Failed" ];     then antReturnCode="Request Status: Failed"
        elif [ "$RESULT_STATUS" == "Succeeded" ];  then antReturnCode="DEPLOYMENT SUCCEEDED"
        elif [ "$RESULT_STATUS" == "InProgress" ]; then antReturnCode="Failed to obtain result from server within specified time"
        else antReturnCode="Request Status: Failed"
        fi
      fi
    elif jq -r '.message' "${LOG}.initial.json" 2>/dev/null | grep -iq "locked"; then
      antReturnCode="ALREADY_IN_PROCESS"
    else
      antReturnCode="Failed to obtain result from server within specified time"
    fi
  fi

  # Prepare TSVs (robust to empty arrays)
  if [ -s "$REPORT_JSON" ]; then
    jq -r '.result.details.componentFailures[]? | [.fileName, .problem] | @tsv' "$REPORT_JSON" > "$COMPONENT_TSV" 2>/dev/null || : > "$COMPONENT_TSV"
    jq -r '.result.details.runTestResult.failures[]? | [.name, .methodName, .message, (.stackTrace // "")] | @tsv' "$REPORT_JSON" > "$TEST_TSV" 2>/dev/null || : > "$TEST_TSV"
    jq -r '.result.details.runTestResult.codeCoverageWarnings[]? | [.name, .message] | @tsv' "$REPORT_JSON" > "$COV_TSV" 2>/dev/null || : > "$COV_TSV"
  else
    : > "$COMPONENT_TSV"; : > "$TEST_TSV"; : > "$COV_TSV"
  fi

  # filtered human log (kept for backward compatibility/attachments)
  if [ -s "$REPORT_JSON" ]; then
    jq -r '.result.details | {componentFailures, runTestResult: {failures, codeCoverageWarnings}}' "$REPORT_JSON" > "${LOG}.filtered.json" 2>/dev/null || true
    jq -r 'to_entries | map("\(.key): \(.value)") | join("\n")' "${LOG}.filtered.json" > "${LOG}.filtered" 2>/dev/null || true
  else
    jq -r '.message // "No report.json available; see error log."' "${LOG}.initial.json" > "${LOG}.filtered" 2>/dev/null || echo "No JSON output captured." > "${LOG}.filtered"
  fi

  case $antReturnCode in
    "DEPLOYMENT SUCCEEDED") HTML_Report SUCCEEDED; PublishLOG changeset ;;
    "ALREADY_IN_PROCESS")   HTML_Report LOCKED;    PublishLOG changeset ;;
    "Request Status: Failed"|"Failed to obtain result from server within specified time")
                            HTML_Report FAILED;    PublishLOG changeset ;;
  esac
}

# ============================== HTML Report (colored + numbered) ==============================

HTML_Report(){
  Report=$1

  SAVEIFS=$IFS
  IFS=$(echo -en "\n\b")

  # Build src index once
  _build_src_index

  # Simple color tokens (email-safe inline)
  BAR_BG="#0D47A1"
  BAR_TX="#FFFFFF"
  SUC_BG="#E8F5E9"
  SUC_TX="#1B5E20"
  FAIL_BG="#FDECEA"
  FAIL_TX="#B71C1C"
  WARN_BG="#FFF8E1"
  WARN_TX="#8D6E00"
  CHIP_BG="#E3F2FD"
  CHIP_TX="#0D47A1"
  GREY_BG="#F5F5F5"
  GREY_TX="#333333"
  LINK_TX="#1565C0"

  echo "<html><body style='font-family:Segoe UI,Arial,sans-serif;font-size:13px;color:#222;margin:0;padding:0;'>" > $HTMLLog

  # Header Bar
  echo "<div style='background:${BAR_BG};color:${BAR_TX};padding:12px 16px;font-weight:600;'>
          ${SFDC_ORG} ChangeSet Validation ${Report}
        </div>" >> $HTMLLog

  # Summary strip
  REQ_ID=$(jq -r '.result.id // "N/A"' "$REPORT_JSON" 2>/dev/null || echo "N/A")
  STATUS=$(jq -r '.result.status // .status // "N/A"' "$REPORT_JSON" 2>/dev/null || echo "N/A")
  SUCCESS=$(jq -r '.result.success // "N/A"' "$REPORT_JSON" 2>/dev/null || echo "N/A")
  echo "<div style='padding:10px 16px;background:${CHIP_BG};color:${CHIP_TX};'>
          <span style='margin-right:14px;'>Request ID: <b>${REQ_ID}</b></span>
          <span style='margin-right:14px;'>Status: <b>${STATUS}</b></span>
          <span style='margin-right:14px;'>Success: <b>${SUCCESS}</b></span>
          <span style='margin-right:14px;'>API: <b>${API}</b></span>
          <span>Git Range: <b>${gitlast}..${gitlatest}</b></span>
        </div>" >> $HTMLLog

  # Quick Links
  echo "<div style='padding:8px 16px;'>
          <a style='color:${LINK_TX};text-decoration:none;margin-right:14px;' href='https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}'>Log & Changeset</a>
          <a style='color:${LINK_TX};text-decoration:none;margin-right:14px;' href='https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}/${SFDC_ORG}.changesetList.${DATE}.html'>Changeset List</a>
          <a style='color:${LINK_TX};text-decoration:none;' href='https://cdnsfdc.cadence.com/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}/${HTMLFDLog##*/}'>ForceDeploy</a>
        </div>" >> $HTMLLog

  # Status banner
  if [ "${Report}" == "SUCCEEDED" ]; then
    echo "<div style='margin:8px 16px 12px;background:${SUC_BG};color:${SUC_TX};border:1px solid #C8E6C9;padding:10px 12px;border-radius:6px;'>
            <b>Deployment Succeeded</b>
          </div>" >> $HTMLLog
  elif [ "${Report}" == "LOCKED" ]; then
    LOCK_TXT=$(jq -r '.result.details // ""' "$REPORT_JSON" 2>/dev/null | grep -i locked | _esc)
    echo "<div style='margin:8px 16px 12px;background:${WARN_BG};color:${WARN_TX};border:1px solid #FFECB3;padding:10px 12px;border-radius:6px;'>
            <b>Org is Locked</b><div style='margin-top:6px;'>${LOCK_TXT}</div>
          </div>" >> $HTMLLog
  else
    echo "<div style='margin:8px 16px 12px;background:${FAIL_BG};color:${FAIL_TX};border:1px solid #F5C6CB;padding:10px 12px;border-radius:6px;'>
            <b>Deployment Failed</b>
          </div>" >> $HTMLLog
  fi

  # ========== Section: Component Failures ==========
  echo "<div style='margin:0 16px 12px;border:1px solid #eee;border-radius:8px;'>
          <div style='background:#ECEFF1;color:#263238;padding:8px 12px;font-weight:600;border-top-left-radius:8px;border-top-right-radius:8px;'>
            Component Failures
          </div>
          <div style='padding:8px 12px;'>" >> $HTMLLog

  if [ -s "$COMPONENT_TSV" ]; then
    idx=1
    while IFS=$'\t' read -r FILE PROBLEM; do
      [ -z "$FILE" ] && continue
      echo "<div style='background:${FAIL_BG};color:${FAIL_TX};border:1px solid #F5C6CB;margin-bottom:8px;border-radius:6px;'>
              <div style='padding:8px 10px;'>
                <div style='font-weight:600;'>${idx}. $(echo "${FILE}" | _esc) -- Error: $(echo "${PROBLEM}" | _esc)</div>
                <div style='margin-top:6px;background:${GREY_BG};color:${GREY_TX};border:1px solid #e0e0e0;border-radius:4px;padding:6px 8px;'>
                  <pre style='margin:0;white-space:pre-wrap;'>$( _gitlog_for_component "${FILE}" | _esc )</pre>
                </div>
              </div>
            </div>" >> $HTMLLog
      idx=$((idx+1))
    done < "$COMPONENT_TSV"
  else
    echo "<div style='color:#555;'>None</div>" >> $HTMLLog
  fi
  echo "</div></div>" >> $HTMLLog

  # ========== Section: Test Failures ==========
  echo "<div style='margin:0 16px 12px;border:1px solid #eee;border-radius:8px;'>
          <div style='background:#FFF3CD;color:#7A5B00;padding:8px 12px;font-weight:600;border-top-left-radius:8px;border-top-right-radius:8px;'>
            Test Failures
          </div>
          <div style='padding:8px 12px;'>" >> $HTMLLog

  if [ -s "$TEST_TSV" ]; then
    idx=1
    while IFS=$'\t' read -r CLASS METHOD MSG STACK; do
      [ -z "$CLASS" ] && continue
      local_title="${CLASS}.${METHOD}() -- Error: ${MSG}"
      echo "<div style='background:#FFFDE7;color:#5D4037;border:1px solid #FFE082;margin-bottom:8px;border-radius:6px;'>
              <div style='padding:8px 10px;'>
                <div style='font-weight:600;'>${idx}. $(echo "${local_title}" | _esc)</div>
                <div style='margin-top:6px;color:#444;'>
                  <pre style='margin:0;white-space:pre-wrap;'>$( echo "${STACK}" | _esc )</pre>
                </div>
                <div style='margin-top:6px;background:${GREY_BG};color:${GREY_TX};border:1px solid #e0e0e0;border-radius:4px;padding:6px 8px;'>
                  <pre style='margin:0;white-space:pre-wrap;'>$( _gitlog_for_component "${CLASS}" | _esc )</pre>
                </div>
              </div>
            </div>" >> $HTMLLog
      idx=$((idx+1))
    done < "$TEST_TSV"
  else
    echo "<div style='color:#555;'>None</div>" >> $HTMLLog
  fi
  echo "</div></div>" >> $HTMLLog

  # ========== Section: Code Coverage Warnings ==========
  echo "<div style='margin:0 16px 16px;border:1px solid #eee;border-radius:8px;'>
          <div style='background:#E1F5FE;color:#01579B;padding:8px 12px;font-weight:600;border-top-left-radius:8px;border-top-right-radius:8px;'>
            Code Coverage Warnings
          </div>
          <div style='padding:8px 12px;'>" >> $HTMLLog

  if [ -s "$COV_TSV" ]; then
    idx=1
    while IFS=$'\t' read -r NAME MESSAGE; do
      [ -z "$NAME" ] && continue
      echo "<div style='background:#E3F2FD;color:#0D47A1;border:1px solid #BBDEFB;margin-bottom:8px;border-radius:6px;'>
              <div style='padding:8px 10px;'>
                <div style='font-weight:600;'>${idx}. $(echo "${NAME}" | _esc) -- Warning: $(echo "${MESSAGE}" | _esc)</div>
                <div style='margin-top:6px;background:${GREY_BG};color:${GREY_TX};border:1px solid #e0e0e0;border-radius:4px;padding:6px 8px;'>
                  <pre style='margin:0;white-space:pre-wrap;'>$( _gitlog_for_component "${NAME}" | _esc )</pre>
                </div>
              </div>
            </div>" >> $HTMLLog
      idx=$((idx+1))
    done < "$COV_TSV"
  else
    echo "<div style='color:#555;'>None</div>" >> $HTMLLog
  fi
  echo "</div></div>" >> $HTMLLog

  # Footer
  echo "<div style='padding:10px 16px;color:#777;font-size:12px;'>Generated on $(date '+%d %b %Y, %H:%M %Z')</div>" >> $HTMLLog

  echo "</body></html>" >> $HTMLLog

  # Attach TSVs so you can sort/filter offline
  EMAIL=${FROM} mutt -e 'set content_type=text/html' \
    -s "---${SFDC_ORG}---ChangeSet Validation ${Report} [$(date +%d.%b.%Y) PST - git ${gitlast}-${gitlatest} ]" \
    ${mutt_MAIL_LIST} \
    -a "$LOG.filtered" "$COMPONENT_TSV" "$TEST_TSV" "$COV_TSV" \
    < "$HTMLLog"

  IFS=$SAVEIFS
}

# ============================== Changeset & publish ==============================

Changeset_List(){
  _build_src_index

  find changeSetDeploy -type f | egrep -v "package.xml|staticResourceFolders.txt" \
    | cut -d "/" -f  1,2 --complement | sort -u > "${DEPLOYEDFILE}"

  changesetFile=$(find changeSetDeploy -type f | egrep -v "package.xml|staticResourceFolders.txt" | wc -l)
  echo "<div style='margin:0 16px 12px;color:#263238;'>Changeset file(s): <b>${changesetFile}</b></div>" >> $HTMLLog

  NUM=1
  while IFS= read -r FILE; do
    [ -z "$FILE" ] && continue
    if [ "${FILE}" == "labels/CustomLabels.labels-meta.xml" ]; then
      FILE="env/${SFDC_ORG}/customLabel/CustomLabels.labels-meta.xml"
    elif [[ "${FILE}" =~ remoteSiteSettings/ ]]; then
      FILE=$(echo "${FILE}" | sed -e "s/^env\/${SFDC_ORG}//g")
    elif [[ "${FILE}" =~ src/customMetadata/ ]]; then
      FILE=$(echo "${FILE}" | sed -e "s/^env\/${SFDC_ORG}//g")
    fi

    LastAuthor="$(
      _resolve_files "${FILE}" | head -n1 | while read -r p; do
        if [ -f "$p" ]; then
          git --no-pager log -1 --date=short --pretty='format:%h %ad %an %s' -- "$p"
        fi
        break
      done
    )"

    echo "<div style='margin:0 16px 6px;background:#FAFAFA;border:1px solid #eee;border-radius:6px;padding:6px 10px;'>
            [$NUM] $(echo "${FILE}" | _esc)
            <div style='margin-top:4px;color:#555;'>
              Last author... $(echo "${LastAuthor}" | _esc)
            </div>
          </div>" >> $HTMLLog
    NUM=$((NUM+1))
  done < "${DEPLOYEDFILE}"
}

CHNGSETLIST () {
  ORGchngSet=${SFDC_ORG}.${DATE}.changeSetDeploy
  ORGchngSetFILE=${Logpath}/${SFDC_ORG}.changesetList.${DATE}
  cp -r changeSetDeploy  ${ORGchngSet}
  if [ -d ${ORGchngSet}/src/staticresources ]; then
    cd ${ORGchngSet}
    bash ${bin}/staticresource_decompress.sh
  fi
  cd - >/dev/null 2>&1 || true
  find ${ORGchngSet}/customSettings/src/env/ ${ORGchngSet}/src/ -type f \
    | egrep -v  "package.xml|staticResourceFolders.txt" \
    | cut -d "/" -f3-20 | sort > ${ORGchngSetFILE}.csv
  sed -e "s/$/<br><br>/ ;1 i<HTML>\n<BODY>" ${ORGchngSetFILE}.csv >  ${ORGchngSetFILE}.html
  sed -i "\$a</BODY>\n</HTML>" ${ORGchngSetFILE}.html
}

PublishLOG(){
  LogStorePath="/data/public/SFDC_LOG/${SFDC_ORG}.GIT_${gitlast}-${gitlatest}.${DATE}"
  mkdir -p ${LogStorePath}

  if [ "$1" == "changeset" ]; then
    cp ${CHANGESETLOG} ${LogStorePath}/$SFDC_ORG.Changeset.log.${DATE} 2>/dev/null || true
    cp ${LOG} ${LogStorePath}/$SFDC_ORG.Deploy.log.${DATE} 2>/dev/null || true
    cp ${HTMLLog} ${LogStorePath}/${SFDC_ORG}.Deploy.log.${DATE}.html 2>/dev/null || true

    cp -r changeSetDeploy ${LogStorePath}/${SFDC_ORG}.changeSetDeploy.${DATE} 2>/dev/null || true
    cp ${ORGchngSetFILE}.html  ${ORGchngSetFILE}.csv ${LogStorePath}/ 2>/dev/null || true
    cp $REPORT_JSON ${LogStorePath}/ 2>/dev/null || true
  fi
}

Unlock(){ rm -f "$LOCK"; }
Trap(){ trap Unlock SIGINT; }
FAIL_EXIT(){ rm -f "$LOCK"; exit; }

# ============================== entry ==============================
main "$@"
